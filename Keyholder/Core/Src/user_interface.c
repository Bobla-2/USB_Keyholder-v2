#include "user_interface.h"
#include "ssd1306.h"
#include "stdio.h"
#include "crypto.h"
#include "main.h"

#define DEBUG

const unsigned char imgN1[] = {
	0xc1, 0x8f, 0x87, 0xf8, 0xc1, 0x9f, 0xc7, 0xfc, 0xc1, 0x98, 0x06, 0x0c, 0xc1, 0x98, 0x06, 0x0c, 
	0xc1, 0x98, 0x06, 0x0c, 0xc1, 0x9f, 0x87, 0xf8, 0xc1, 0x8f, 0xc7, 0xf8, 0xc1, 0x80, 0xc6, 0x0c, 
	0xc1, 0x80, 0xc6, 0x0c, 0xe3, 0x80, 0xc6, 0x0c, 0x7f, 0x1f, 0xc7, 0xfc, 0x3e, 0x0f, 0x87, 0xf8, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x20, 0xff, 0xff, 0xff, 0xfc, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 0x95, 0x15, 0x15, 0x24, 
	0x8e, 0x0e, 0x0e, 0x24, 0x8e, 0x0e, 0x0e, 0x24, 0x95, 0x15, 0x15, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x20, 
	0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00
};
const unsigned char imgN2[] = {
	0xc1, 0x80, 0x07, 0xf8, 0xc1, 0x87, 0x87, 0xfc, 0xc1, 0x8c, 0x86, 0x0c, 0xc1, 0x98, 0x86, 0x0c, 
	0xc1, 0x80, 0x86, 0x0c, 0xc1, 0x80, 0x87, 0xf8, 0xc1, 0x81, 0x07, 0xf8, 0xc1, 0x82, 0x06, 0x0c, 
	0xc1, 0x86, 0x06, 0x0c, 0xe3, 0x8c, 0x06, 0x0c, 0x7f, 0x0f, 0xc7, 0xfc, 0x3e, 0x00, 0x07, 0xf8, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x20, 0xff, 0xff, 0xff, 0xfc, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 0x95, 0x15, 0x15, 0x24, 
	0x8e, 0x0e, 0x0e, 0x24, 0x8e, 0x0e, 0x0e, 0x24, 0x95, 0x15, 0x15, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x20, 
	0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00
};
const unsigned char imgN3[] = {
	0xc1, 0x80, 0x07, 0xf8, 0xc1, 0x80, 0x07, 0xfc, 0xc1, 0x8f, 0x86, 0x0c, 0xc1, 0x98, 0x86, 0x0c, 
	0xc1, 0x80, 0x86, 0x0c, 0xc1, 0x87, 0x87, 0xf8, 0xc1, 0x87, 0x87, 0xf8, 0xc1, 0x80, 0x86, 0x0c, 
	0xc1, 0x80, 0x86, 0x0c, 0xe3, 0x80, 0x86, 0x0c, 0x7f, 0x01, 0x87, 0xfc, 0x3e, 0x3f, 0x07, 0xf8, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x20, 0xff, 0xff, 0xff, 0xfc, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 0x95, 0x15, 0x15, 0x24, 
	0x8e, 0x0e, 0x0e, 0x24, 0x8e, 0x0e, 0x0e, 0x24, 0x95, 0x15, 0x15, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x20, 
	0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00
};
const unsigned char imgN4[] = {
  0xc1, 0x80, 0x07, 0xf8, 0xc1, 0x84, 0x47, 0xfc, 0xc1, 0x88, 0x46, 0x0c, 0xc1, 0x88, 0x46, 0x0c, 
	0xc1, 0x88, 0xc6, 0x0c, 0xc1, 0x8d, 0xc7, 0xf8, 0xc1, 0x87, 0x87, 0xf8, 0xc1, 0x80, 0x86, 0x0c, 
	0xc1, 0x80, 0x86, 0x0c, 0xe3, 0x80, 0x86, 0x0c, 0x7f, 0x01, 0x07, 0xfc, 0x3e, 0x01, 0x07, 0xf8, 
	0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x20, 0xff, 0xff, 0xff, 0xfc, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 0x95, 0x15, 0x15, 0x24, 
	0x8e, 0x0e, 0x0e, 0x24, 0x8e, 0x0e, 0x0e, 0x24, 0x95, 0x15, 0x15, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x20, 
	0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00
};
const unsigned char img_settings[] = {
  0x00, 0x07, 0x80, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x0c, 0x0f, 0xc0, 0xc0, 0x1e, 0x0f, 0xc1, 0xe0, 
	0x3f, 0x3f, 0xf3, 0xf0, 0x3f, 0xff, 0xff, 0xf0, 0x1f, 0xff, 0xff, 0xe0, 0x0f, 0xff, 0xff, 0xc0, 
	0x07, 0xf8, 0x7f, 0x80, 0x07, 0xe0, 0x1f, 0x80, 0x0f, 0xc0, 0x0f, 0xc0, 0x0f, 0x87, 0x87, 0xc0, 
	0x7f, 0x8f, 0xc7, 0xf8, 0xff, 0x1c, 0xe3, 0xfc, 0xff, 0x18, 0x63, 0xfc, 0xff, 0x18, 0x63, 0xfc, 
	0xff, 0x1c, 0xe3, 0xfc, 0x7f, 0x8f, 0xc7, 0xf8, 0x0f, 0x87, 0x87, 0xc0, 0x0f, 0xc0, 0x0f, 0xc0, 
	0x07, 0xe0, 0x1f, 0x80, 0x07, 0xf8, 0x7f, 0x80, 0x0f, 0xff, 0xff, 0xc0, 0x1f, 0xff, 0xff, 0xe0, 
	0x3f, 0xff, 0xff, 0xf0, 0x3f, 0x3f, 0xf3, 0xf0, 0x1e, 0x0f, 0xc1, 0xe0, 0x0c, 0x0f, 0xc0, 0xc0, 
	0x00, 0x0f, 0xc0, 0x00, 0x00, 0x07, 0x80, 0x00
};
const unsigned char img_usb_write[] = {
	0xc1, 0x8f, 0x87, 0xf8, 0xc1, 0x9f, 0xc7, 0xfc, 0xc1, 0x98, 0x06, 0x0c, 0xc1, 0x98, 0x06, 0x0c, 
	0xc1, 0x98, 0x06, 0x0c, 0xc1, 0x9f, 0x87, 0xf8, 0xc1, 0x8f, 0xc7, 0xf8, 0xc1, 0x80, 0xc6, 0x0c, 
	0xc1, 0x80, 0xc6, 0x0c, 0xe3, 0x80, 0xc6, 0x0c, 0x7f, 0x1f, 0xc7, 0xfc, 0x3e, 0x0f, 0x87, 0xf8, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x20, 0xff, 0xff, 0xff, 0xfc, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 0x95, 0x15, 0x15, 0x24, 
	0x8e, 0x0e, 0x0e, 0x24, 0x8e, 0x0e, 0x0e, 0x24, 0x95, 0x15, 0x15, 0x24, 0xa4, 0xa4, 0xa4, 0xa4, 
	0x80, 0x00, 0x00, 0x24, 0x80, 0x00, 0x00, 0x24, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x20, 
	0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00
};
const unsigned char img_passwords[] = {
	0x0f, 0xff, 0xf0, 0x00, 0x0f, 0xff, 0xf8, 0x00, 0x0c, 0x00, 0x1c, 0x00, 0x0c, 0x00, 0x0e, 0x00, 
	0x0c, 0xfc, 0x07, 0x00, 0x0c, 0x00, 0x03, 0x80, 0x0c, 0x00, 0xf9, 0xc0, 0x0c, 0x01, 0xfc, 0xc0, 
	0x0c, 0xf3, 0xce, 0xc0, 0x0c, 0x03, 0x86, 0xc0, 0x0c, 0x03, 0x86, 0xc0, 0x0c, 0x03, 0xce, 0xc0, 
	0x0c, 0xc7, 0xfe, 0xc0, 0x0c, 0x0f, 0xfc, 0xc0, 0x0c, 0x1f, 0xf8, 0xc0, 0x0c, 0x3e, 0x00, 0xc0, 
	0x0c, 0x7e, 0x00, 0xc0, 0x0c, 0xf8, 0x1c, 0xc0, 0x0d, 0xf8, 0x00, 0xc0, 0x0d, 0xe0, 0x00, 0xc0, 
	0x0c, 0xe0, 0x00, 0xc0, 0x0c, 0x01, 0xfc, 0xc0, 0x0c, 0x00, 0x00, 0xc0, 0x0c, 0x00, 0x00, 0xc0, 
	0x0c, 0x00, 0x00, 0xc0, 0x0c, 0xff, 0xfc, 0xc0, 0x0c, 0x00, 0x00, 0xc0, 0x0c, 0x00, 0x00, 0xc0, 
	0x0f, 0xff, 0xff, 0xc0, 0x0f, 0xff, 0xff, 0xc0
};


void menu_login( void );
void menu_main ( void );
void menu_passwords( void );
void menu_settings ( void );
void menu_usb_write( void );
	
const int menuItemsCount = 4;
char passTrue[6] = "111111";
char pass[6];
int orentationMoveMenu = 0;
int cycleFlag = 0;
int numMenuItem = 0;


uint8_t currentTab = login_tab;


void UI_print_menu( void ){
	switch(currentTab){
		case main_tab:
			menu_main();
			break;
		case usb_write_tab:
			menu_usb_write();
			break;
		case paswd_list_tab:
			menu_passwords();
			break;
		default:
			menu_login();
	}
}


void menu_login( void ){
	#ifndef DEBUG
	ssd1306_Fill(Black);
	ssd1306_DrawRectangle(0, 0, 127, 31, White);
	
	for (int j = 0; j < 6; j++){
		while(!switches_byte)
			HAL_Delay(1);
		
		ssd1306_SetCursor(2 + 16 * j, 2);
		for(int i = 0; i < 8; i++){
			if(switches_byte & (1 << i)){		
				pass[j] = i + '1';	
				ssd1306_WriteChar(i + '1', Font_16x26, White);
				break;
			}
		}
		
		for(int i = 0; i < j; i++){
			ssd1306_SetCursor(2 + 16 * i, 2);		
			ssd1306_WriteChar('*', Font_16x26, White);
		}
		
		ssd1306_UpdateScreen(); 
		
		while(switches_byte)
			HAL_Delay(1);
	}
	int unPass = 0;
	for (int i = 0; i < 6; i++){
		if (pass[i] == passTrue[i]){
			unPass++;
		}
	}
	if (unPass == 6)
		currentTab = main_tab;
	#else
	currentTab = main_tab;
	#endif
}

void menu_main ( void ){
	ssd1306_Fill(Black);
	if (cycleFlag == 0){
		ssd1306_DrawBitmap(34, 0, imgN1,  30, 30, White);
		ssd1306_DrawBitmap(68, 0, imgN2,  30, 30, White);
		ssd1306_UpdateScreen();
		cycleFlag = 1;
	}
	int pushedButtonNumber = 0;
	ssd1306_Fill(Black);
	
	while(!switches_byte)
		HAL_Delay(1);
	
	for(int i = 0; i < 8; i++){
		if(switches_byte & (1 << i)){			
				pushedButtonNumber = i ;
				break;
		}
	}
	if(pushedButtonNumber == 0){
		numMenuItem--;
		orentationMoveMenu = -1;
	}else if(pushedButtonNumber == 1){
		numMenuItem++;
		orentationMoveMenu = 1;
	}
			
	
	ssd1306_Line(36, 31, 68, 31, White);
	ssd1306_Line(46, 31, 58, 31, White);
	if(orentationMoveMenu == 1){
		switch (numMenuItem){
			case -2:
				numMenuItem = 3;
				ssd1306_DrawBitmap(0, 0, imgN3,  30, 30, White);
				ssd1306_UpdateScreen();
			break;
			case -1:
				ssd1306_DrawBitmap(68, 0, imgN1,  30, 30, White);
				ssd1306_UpdateScreen();
			break;
			case 0:
				
				ssd1306_DrawBitmap(34, 0, imgN1,  30, 30, White);
				ssd1306_DrawBitmap(68, 0, imgN2,  30, 30, White);
				ssd1306_UpdateScreen();

				
				break;
			case 1:
				
				for(int i = 32; i != 0; i-=2){
					ssd1306_Fill(Black);
					ssd1306_DrawBitmap(i, 0, imgN1,  30, 30, White);
					ssd1306_DrawBitmap(i+34, 0, imgN2,  30, 30, White);
					ssd1306_Line(36, 31, 68, 31, White);
					ssd1306_Line(46, 31, 58, 31, White);
					if ( i == 2)
						ssd1306_DrawBitmap(68, 0, imgN3,  30, 30, White);
					ssd1306_UpdateScreen();
					HAL_Delay(2);
				}
			
				break;
			case 2:
				for(int i = 32; i != 0; i-=2){
					ssd1306_Fill(Black);
					ssd1306_DrawBitmap(i, 0, imgN2,  30, 30, White);
					ssd1306_DrawBitmap(i+34, 0, imgN3,  30, 30, White);
					ssd1306_Line(36, 31, 68, 31, White);
					ssd1306_Line(46, 31, 58, 31, White);
					ssd1306_UpdateScreen();
					HAL_Delay(2);
				}
						
				break;
			case 3:
				ssd1306_DrawBitmap(0, 0, imgN3,  30, 30, White);
				ssd1306_UpdateScreen();
				break;
			case 4:
				numMenuItem = -1;
				ssd1306_DrawBitmap(68, 0, imgN1,  30, 30, White);
				ssd1306_UpdateScreen();
				break;
			}
	}else{
			switch (numMenuItem){
			case -2:
				numMenuItem = 3;
				ssd1306_DrawBitmap(0, 0, imgN3,  30, 30, White);
				ssd1306_UpdateScreen();
			break;
			case -1:
				ssd1306_DrawBitmap(68, 0, imgN1,  30, 30, White);
				ssd1306_UpdateScreen();
			break;
			case 0:
				
				ssd1306_DrawBitmap(34, 0, imgN1,  30, 30, White);
				ssd1306_DrawBitmap(68, 0, imgN2,  30, 30, White);
				ssd1306_UpdateScreen();
	
				break;
			case 1:
				ssd1306_DrawBitmap(0, 0, imgN1,  30, 30, White);
				ssd1306_DrawBitmap(34, 0, imgN2,  30, 30, White);
				ssd1306_DrawBitmap(68, 0, imgN3,  30, 30, White);
				ssd1306_UpdateScreen();
				
				break;
			case 2:
				
				ssd1306_DrawBitmap(0, 0, imgN2,  30, 30, White);
				ssd1306_DrawBitmap(34, 0, imgN3,  30, 30, White);
				ssd1306_UpdateScreen();

				break;
			case 3:
				ssd1306_DrawBitmap(0, 0, imgN3,  30, 30, White);
				ssd1306_UpdateScreen();
				break;
			case 4:
				numMenuItem = -1;
				ssd1306_DrawBitmap(68, 0, imgN1,  30, 30, White);
				ssd1306_UpdateScreen();
				break;
			}
	}
	
	
/*	if(numMenuItem == menuItemsCount + 1){			
			numMenuItem = 0;		
	}
	else if(numMenuItem == 0){			
			numMenuItem = menuItemsCount-1;		
	}
	
	ssd1306_DrawBitmap(((numMenuItem - 1)* 34 + 4), 0, imgN1,  30, 30, White);
	ssd1306_DrawBitmap((numMenuItem * 34) + 4, 0, imgN2,  30, 30, White);
	if(numMenuItem != (menuItemsCount+1))
	ssd1306_DrawBitmap(((numMenuItem + 1) * 34 + 4), 0, imgN3,  30, 30, White);
	ssd1306_Line(36, 31, 68, 31, White);
	ssd1306_UpdateScreen();
	*/
	while(switches_byte)
			HAL_Delay(1);
	
	
}

void menu_passwords( void ){
	
}

void menu_settings ( void ){
	
}

void menu_usb_write( void ){
	
}
